name: Release & Deploy to Railway CDN

on:
  push:
    tags:
      - 'v*.*.*'  # Triggers on version tags like v1.0.0

env:
  PLUGIN_SLUG: wordpress-ai-assistant
  RAILWAY_CDN_URL: https://updates.amiteam.io

jobs:
  build-and-release:
    name: Build ZIP & Create Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get_version.outputs.version }}
      tag_name: ${{ steps.get_version.outputs.tag_name }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          tools: composer

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Get version from tag
        id: get_version
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          VERSION=${TAG_NAME#v}
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "tag_name=${TAG_NAME}" >> $GITHUB_OUTPUT
          echo "Version: ${VERSION}"
          echo "Tag: ${TAG_NAME}"

      - name: Install PHP dependencies
        if: ${{ hashFiles('composer.json') != '' }}
        run: composer install --no-dev --optimize-autoloader --prefer-dist

      - name: Install Node.js dependencies
        if: ${{ hashFiles('package.json') != '' }}
        run: npm ci

      - name: Build assets
        if: ${{ hashFiles('package.json') != '' }}
        run: npm run build || echo "No build script found"

      - name: Create distribution directory
        run: |
          mkdir -p dist/${{ env.PLUGIN_SLUG }}

          # Copy files excluding dev files
          rsync -av --exclude-from='.distignore' \
            --exclude='.git*' \
            --exclude='node_modules' \
            --exclude='tests' \
            --exclude='.github' \
            --exclude='*.md' \
            . dist/${{ env.PLUGIN_SLUG }}/

      - name: Create ZIP archive
        run: |
          cd dist
          zip -r ../${{ env.PLUGIN_SLUG }}.zip ${{ env.PLUGIN_SLUG }}
          cd ..
          echo "ZIP created: ${{ env.PLUGIN_SLUG }}.zip"
          ls -lh ${{ env.PLUGIN_SLUG }}.zip

      - name: Generate plugin-info.json
        run: |
          VERSION=${{ steps.get_version.outputs.version }}
          TAG_NAME=${{ steps.get_version.outputs.tag_name }}

          cat > plugin-info.json << EOF
          {
            "${{ env.PLUGIN_SLUG }}/${{ env.PLUGIN_SLUG }}.php": {
              "name": "WordPress AI Assistant",
              "slug": "${{ env.PLUGIN_SLUG }}",
              "version": "${VERSION}",
              "author": "Amit Trabelsi",
              "author_profile": "https://amit-trabelsi.co.il",
              "requires": "5.0",
              "tested": "6.6",
              "requires_php": "7.4",
              "last_updated": "$(date +'%Y-%m-%d %H:%M:%S')",
              "package": "https://github.com/${{ github.repository }}/releases/download/${TAG_NAME}/${{ env.PLUGIN_SLUG }}.zip",
              "download_url": "https://github.com/${{ github.repository }}/releases/download/${TAG_NAME}/${{ env.PLUGIN_SLUG }}.zip",
              "sections": {
                "description": "תוסף WordPress מתקדם המספק יכולות בינה מלאכותית לשיפור תהליכי יצירת תוכן",
                "changelog": "גרסה ${VERSION} - ראה את רשימת השינויים המלאה ב-GitHub"
              },
              "banners": {
                "low": "",
                "high": ""
              },
              "icons": {
                "1x": "",
                "2x": ""
              }
            }
          }
          EOF

          cat plugin-info.json
          echo "plugin-info.json created successfully"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            ${{ env.PLUGIN_SLUG }}.zip
            plugin-info.json
          generate_release_notes: true
          body: |
            ## גרסה ${{ steps.get_version.outputs.version }}

            ### התקנה מהירה
            הורד את קובץ ה-ZIP והתקן דרך ממשק התוספים של WordPress.

            ### עדכון אוטומטי
            הפלאגין יעדכן אוטומטית מ-GitHub Releases.

            **Download:** [${{ env.PLUGIN_SLUG }}.zip](https://github.com/${{ github.repository }}/releases/download/${{ steps.get_version.outputs.tag_name }}/${{ env.PLUGIN_SLUG }}.zip)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  deploy-to-railway:
    name: Update Railway CDN
    runs-on: ubuntu-latest
    needs: build-and-release

    steps:
      - name: Checkout Railway CDN repo
        uses: actions/checkout@v4
        with:
          repository: ${{ secrets.RAILWAY_CDN_REPO }}  # e.g., amit-trabelsi/wp-plugins-cdn
          token: ${{ secrets.RAILWAY_CDN_TOKEN }}
          path: cdn-server

      - name: Download plugin-info.json from release
        run: |
          VERSION=${{ needs.build-and-release.outputs.version }}
          TAG_NAME=${{ needs.build-and-release.outputs.tag_name }}

          mkdir -p cdn-server/public/${{ env.PLUGIN_SLUG }}

          # Download plugin-info.json from the release
          curl -L -o cdn-server/public/${{ env.PLUGIN_SLUG }}/plugin-info.json \
            "https://github.com/${{ github.repository }}/releases/download/${TAG_NAME}/plugin-info.json"

          echo "Updated plugin-info.json for version ${VERSION}"

      - name: Commit and push to Railway CDN
        run: |
          cd cdn-server
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add public/${{ env.PLUGIN_SLUG }}/plugin-info.json
          git commit -m "Update ${{ env.PLUGIN_SLUG }} to version ${{ needs.build-and-release.outputs.version }}" || echo "No changes to commit"
          git push

      - name: Trigger Railway deployment
        run: |
          echo "Railway will auto-deploy from the git push"
          echo "CDN URL: ${{ env.RAILWAY_CDN_URL }}/${{ env.PLUGIN_SLUG }}/plugin-info.json"
